define(["snmd-core/js/Core","snmd-core/js/GUI","js-logger","jquery"],function(t,s,i,a){"use strict";var h={},e=function(t,s,i,h,e){this.opts=i,this.lines=h;var o;if(void 0!==this.opts.lcls)for(o=0;o<this.lines.length;o++){var l=this.opts.lcls.slice(0);this.opts.lcls.forEach(function(t){l.push(t+"-"+this.lines[o].name),l.push(t+"-"+o)},this),this.lines[o].style={class:l.join(" ")}}if(void 0===this.opts.desc.group?(void 0!==this.opts.mcls&&(this.maxline_style={class:this.opts.mcls.join(" ")}),this.group_max=!1):(this.group_max=!0,this.group_view=t._container.id,this.group_name=this.opts.desc.group,this.group_widget=s.id),this.root=t,i.dim={id:s.id,x:s.x.baseVal.value,y:s.y.baseVal.value,width:s.width.baseVal.value,height:s.height.baseVal.value},t.remove(s),this.rect=t.rect(i.dim.x,i.dim.y,i.dim.width,i.dim.height,{id:i.dim.id,class:i.cls.base.join(" ")}),void 0!==e){var d=a(this.rect);d.addClass("snmd-bcl-Widget"),d.qtip(e)}for(this.txt=[t.text(i.dim.x,i.dim.y,"")],h.length>1&&(this.txt[1]=t.text(i.dim.x+i.dim.width,i.dim.y,"")),o=0;o<this.txt.length;o++)void 0!==this.opts.tcls&&this.opts.tcls.forEach(function(t){this.txt[o].classList.add(t),this.txt[o].classList.add(t+"-"+this.lines[o].name),this.txt[o].classList.add(t+"-"+o)},this);this.data_tswin=(i.dim.width-6)/i.dpi,this.data_ts=[],this.data_lines=[],this.data_svg=[];var n;for(n=0;n<h.length;n++)this.data_lines[n]=[];this.axis_maxlines=[],this.axis_maxlasts=[]};return e.prototype.group_maxy=function(t){return void 0===h[this.group_view]&&(h[this.group_view]={}),void 0===h[this.group_view][this.group_name]&&(h[this.group_view][this.group_name]={}),h[this.group_view][this.group_name][this.group_widget]=t,Math.max.apply(null,Object.values(h[this.group_view][this.group_name]))},e.prototype.update=function(a,h,e){this.data_ts.push(a);var o,l,d=void 0===this.opts.axis[0].max?0:this.opts.axis[0].max;for(o=0;o<this.data_lines.length;o++)("number"!=typeof(l=h[o])||isNaN(l))&&(l=0),this.data_lines[o].push(l),d=Math.max(d,Math.max.apply(null,this.data_lines[o]));this.group_max&&(d=this.group_maxy(d));for(var n,r=[];this.data_ts[0]<a-this.data_tswin;)for(n=this.data_ts.shift(),o=0;o<this.data_lines.length;o++)r[o]=this.data_lines[o].shift();if(void 0!==n&&this.data_ts.length>0){var p=a-this.data_tswin;for(this.data_ts.unshift(p),o=0;o<this.data_lines.length;o++)this.data_lines[o].unshift(r[o]+(this.data_lines[o][0]-r[o])*(p-n)/(this.data_ts[1]-n))}void 0!==this.opts.axis[0].max&&this.axis_maxlasts[0]!==d&&(this.axis_maxlasts[0]=d),"log"===this.opts.axis[0].scale&&(d=Math.log10(d));var m=this.opts.dim.x+this.opts.dim.width-3,_=this.opts.dim.y+this.opts.dim.height-3,x=(this.opts.dim.height-20)/d,g=[],u=[];if(!this.group_max&&void 0!==this.opts.axis[0].max){var c=this.opts.axis[0].max<this.axis_maxlasts[0]?Math.floor(this.axis_maxlasts[0]/this.opts.axis[0].max):0;for(o=0;o<c;o++){void 0!==this.axis_maxlines[o]&&g.push(this.axis_maxlines[o]);var v=_-(o+1)*this.opts.axis[0].max*x;this.axis_maxlines[o]=this.root.line(this.opts.dim.x,v,this.opts.dim.x+this.opts.dim.width,v,this.maxline_style)}this.axis_maxlines.length>c&&(g=g.concat(this.axis_maxlines.splice(c,this.axis_maxlines.length-c)))}var f;for(f=0;f<this.data_lines.length;f++){var y=[],w=!0;if(void 0!==this.data_svg[f]){var b=window.getComputedStyle(this.data_svg[f]);"none"!==b.fill&&""!==b.fill||(w=!1)}var j;for(j=0;j<this.data_ts.length;j++){var N=m+(this.data_ts[j]-a)*this.opts.dpi;w&&0===j&&y.push([N,_]),l=this.data_lines[f][j],"log"===this.opts.axis[0].scale&&(l=l>1?Math.log10(l):0),l*=x,y.push([N,_-l]),j===this.data_ts.length-1&&(w&&y.push([N,_]),u[f]=this.data_lines[f][j])}void 0!==this.data_svg[f]&&g.push(this.data_svg[f]);try{this.data_svg[f]=w?this.root.polygon(y,this.lines[f].style):this.root.polyline(y,this.lines[f].style)}catch(t){i.error("[Chart] Failed to create poly for "+this.rect.id)}void 0!==this.txt[f]&&(this.txt[f].textContent=t.srSiFormatNum(u[f],void 0===this.lines[f].unit?"":this.lines[f].unit,"-"))}for(;g.length;){var C=g.shift();this.root.remove(C)}e===this.last_state||isNaN(e)&&isNaN(this.last_state)||(this.opts.cls.state.forEach(function(t){this.rect.classList.remove(t+this.last_state)},this),this.opts.cls.state.forEach(function(t){this.rect.classList.add(t+e)},this),this.last_state=e,s.srStateChanged(this.rect.parentElement.parentElement.id,this.rect.id,e))},e});